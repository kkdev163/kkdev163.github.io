<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-presentation" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">云音乐前端性能监控平台 | kkdev163</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kkdev163.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kkdev163.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kkdev163.github.io/presentation/web-apm"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="云音乐前端性能监控平台 | kkdev163"><meta data-rh="true" name="description" content="演讲 PPT: 云音乐前端性能监控平台"><meta data-rh="true" property="og:description" content="演讲 PPT: 云音乐前端性能监控平台"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2019-06-13T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://kkdev163.github.io"><meta data-rh="true" property="article:tag" content="web,performance,apm"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kkdev163.github.io/presentation/web-apm"><link data-rh="true" rel="alternate" href="https://kkdev163.github.io/presentation/web-apm" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://kkdev163.github.io/presentation/web-apm" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="kkdev163 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="kkdev163 Atom Feed">



<link rel="alternate" type="application/rss+xml" href="/presentation/rss.xml" title="kkdev163 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/presentation/atom.xml" title="kkdev163 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8dcef9a5.css">
<link rel="preload" href="/assets/js/runtime~main.59883482.js" as="script">
<link rel="preload" href="/assets/js/main.03c6f4a0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">kkdev163</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog">文章</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/presentation">演讲</a><a class="navbar__item navbar__link" href="/about">关于我</a><a href="https://github.com/kkdev163" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">最近演讲</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/presentation/febase">Febase 的工程设计与实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/presentation/wechaty">微信聊天机器人</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/presentation/gmtc-web-monitor">GMTC 2021 参会分享之-前端质量保障专题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/presentation/web-vitals">谷歌体验度量指标集 Web Vitals</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/presentation/web-apm">云音乐前端性能监控平台</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/presentation/performance-basic">页面渲染性能优化基础</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="演讲 PPT: 云音乐前端性能监控平台"><header><h1 class="title_f1Hy" itemprop="headline">云音乐前端性能监控平台</h1><div class="container_mt6G margin-vert--md"><time datetime="2019-06-13T00:00:00.000Z" itemprop="datePublished">2019年6月13日</time> · <!-- -->阅读需 27 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/34838245?v=4" alt="kkdev163" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">kkdev163</span></a></div><small class="avatar__subtitle" itemprop="description">Web 全栈开发工程师@NetEase</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>演讲 PPT: <a href="https://docs.google.com/presentation/d/18qGCugsDHTBBKgdpR-hsF9T4Blg2Yt_cv74NNxkfMJ0/edit#slide=id.g28626a33313_2_982" target="_blank" rel="noopener noreferrer">云音乐前端性能监控平台</a></p><p>演讲场所: 网易-集团前端沙龙</p><p>演讲简介: 介绍了云音乐前端性能监控平台。主要包括:</p><ul><li>1、平台定位、功能模块介绍。</li><li>2、平台架构设计与搭建之路。</li><li>3、平台存在的问题与后续的改进规划。</li></ul><p>演讲时间: 2019-06-13</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_S0QG"><p>以下为演讲逐字稿</p></div></div><h1>演讲逐字稿</h1><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h3><p>大家好，我是 kkdev163，来自云音乐前端技术组，今天带来的主题是云音乐 WebAPM 平台。</p><p>本次分享会分为三个部分，第一部分将介绍平台的定位及已有的功能模块。希望能让大家了解到平台的功能为何这样设计，了解这个平台可以解决什么问题，对大家的工作可以有哪些帮助等。</p><p>第二部分将介绍平台的架构演进之路。</p><p>希望能帮助大家掌握搭建通用监控系统所需的技术栈、了解其中的难点与解决思路。为后续解决相似的架构问题，提供参考。</p><p>第三部分将介绍平台后续的规划</p><p>会点出平台当前存在的不足与后续的改进思路，希望能引起大家的共同思考，帮助平台持续改进。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第一部分">第一部分<a href="#第一部分" class="hash-link" aria-label="第一部分的直接链接" title="第一部分的直接链接">​</a></h3><p>我们开始第一部分，平台的定位及已有功能模块的介绍。</p><ul><li>APM 是应用性能监控的简称。</li><li>它应该帮助开发者提升应用性能质量。</li><li>它应该提供一种衡量标准，能够证明我们产出的应用具有良好的性能与用户体验。</li><li>它的终极目标是 Make the web more awesome.</li></ul><p>如果从监控手段来分区，平台的功能大致可以分为两个方向。</p><ul><li><p>真实用户性能监控，它需要在页面上安装 SDK, 在用户访问页面时，采集上报用户真实的性能数据。</p></li><li><p>实验室合成测试监控，业界常见的性能测试有 Lighthouse、WebpageTest 等。它通过持续地测试来达成监控目的。</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="真实用户性能监控">真实用户性能监控<a href="#真实用户性能监控" class="hash-link" aria-label="真实用户性能监控的直接链接" title="真实用户性能监控的直接链接">​</a></h4><p>我们首先来看下真实用户性能监控。
开发者安装 sdk 后，可以看到应用的访问量数据、页面加载时性能、页面运行时性能、并且可以通过数据分析模块，来进行多维度的数据分析。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="访问量数据">访问量数据<a href="#访问量数据" class="hash-link" aria-label="访问量数据的直接链接" title="访问量数据的直接链接">​</a></h5><p>访问量数据包含 PV/UV、访问量 Top10 页面、用户浏览器占比、操作系统占比等。</p><p>通过这一部分数据，可以让我们对使用我们应用的用户更加了解，可以支撑我们做一些决策，如不再支持某款浏览器、或是性能测试需要覆盖到某个系统版本以上。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="加载时性能">加载时性能<a href="#加载时性能" class="hash-link" aria-label="加载时性能的直接链接" title="加载时性能的直接链接">​</a></h5><p>APM 会给出不同页面的加载时性能数据，这一部分的数据源是通过 W3C 性能工作组产出的 Navigation API 采集到的。</p><p>APM 会计算出页面加载时，关键时间节点的走势，如首次渲染时间、页面完全加载时间等。</p><p>除了走势，我们还计算出一段时间内，页面加载过程中各阶段耗时的瀑布流。可以较清晰的看到，页面加载过程中，在哪些阶段有较高的时间开销。。</p><p>同时我们也基于 IP 分析出各地区用户的加载性能情况。</p><p>并给出了性能样本的分布，如果需要验证应用的秒开率，95%分位数等可以在这里验证。</p><p>应用的加载时性能数据是这几块。其中有些部分我们可以有主动优化的能力，如 DOM 解析、资源加载耗时等。</p><p>有些部分我们不能做什么，如 TCP 连接、CDN 的地区网络状况等。。但是有了这部分数据，有了与其他应用的对比后，我们也可以尝试去推动上下游进行优化。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="页运行时性能">页运行时性能<a href="#页运行时性能" class="hash-link" aria-label="页运行时性能的直接链接" title="页运行时性能的直接链接">​</a></h5><p>页面运行时性能我们主要通过 W3C 性能工作组产出的 Longtask API 采集页面运行过程中的长耗时任务。</p><p>并给出了长耗时任务的走势及持续时长的分布情况。。</p><p>那什么是长耗时任务 Longtask 呢？
我们打开 Chrome 的 Performance.</p><p>主线程的工作是由这样一个一个的 Task 组成，当一个 Task 的执行超过 50ms 时，就可能会影响一帧的渲染，造成页面的卡顿。。</p><p>Longtask 可以用来帮助侦测页面运行时的卡顿率。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="数据分析模块">数据分析模块<a href="#数据分析模块" class="hash-link" aria-label="数据分析模块的直接链接" title="数据分析模块的直接链接">​</a></h5><p>前面的模块都是按照页面整体维度，给出一个性能指标。。</p><p>而在数据分析模块中，我们可以选择不同的维度进行分析。。</p><p>比如我们这里选择了操作系统维度，来看一看 Android 与 iOS 设备的页面加载性能走势。。可以看到 Android 要比 iOS 高出一秒左右。</p><p>内置的事件有</p><ul><li>页面访问量</li><li>加载时性能</li><li>运行时性能</li></ul><p>可选的分析维度有</p><ul><li>页面地址</li><li>浏览器版本</li><li>操作系统版本
等。。</li></ul><p>除了这些系统预设的指标之外呢，我们还提供了自定义埋点 API。</p><p>可以在数据分析模块，查看到我们开发侧关心的一些埋点事件。可以应对大部分的自定义埋点需求。甚至是 Node JS 服务端的一些埋点，也可以打到 WebAPM 平台中。。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="实验室合成监控">实验室合成监控<a href="#实验室合成监控" class="hash-link" aria-label="实验室合成监控的直接链接" title="实验室合成监控的直接链接">​</a></h4><p>APM 平台底层采用的是谷歌的 Lighthouse。</p><p>在这个页面,我们只需输入一个 url 地址，就可以发起一次 Lighthouse 测试。</p><p>等待数秒后，会展示测试的结果。</p><p>我们提供了原始的测试报告供下载。</p><p>并从测试报告中提炼了一些关键的指标，这些指标有 FCP、FMP、Speed Index、First CPU Idle、TTI 等。</p><p>需要说明的是, 这些指标不是从浏览器的 API 中采集的，他是对页面加载过程中逐帧进行截屏，根据图像算法，来计算出以上的几个指标。所以他会更接近用户的直观感受，会比 RUM 中的指标更会准确。</p><p>我们从分析的结果中，还提炼了页面首屏的加载资源，引导开发者去尽量减少关键渲染路径中的资源大小与数量。。</p><p>其实谷歌的 Chrome 中已经内置了 Lighthouse 的测试功能，那么我们为什么还要在 APM 平台上来测试呢，有什么区别吗？</p><p>我们先来铺垫一个细节，Lighthouse Performance 的分数是根据这五项的指标，按照权重计算出来的</p><ul><li>first-contentful-paint 3</li><li>first-meaningful-paint 1</li><li>speed-index 4</li><li>interactive 5</li><li>first-cpu-idle 2</li><li>estimated-input-latency 0</li></ul><p>这几项结果与测试浏览器所在的宿主机的网速、CPU 等都是相关的。所以在不同的宿主环境下测试，结果会存在波动，说直白点就是领导说你的 Lighthouse 分数很低啊，你说我电脑上是好的，这没有说服力。。</p><p>了解了这个细节后，我们来回到为什么使用 APM 平台来测试会更好？</p><p>首先 APM 的 Lighthouse 测试是在服务端的 Docker 容器内，使用无头浏览器进行测试，所有的页面会在一个相对稳定与一致的宿主浏览器环境下进行测试。。优势一就是测试的宿主环境相对一致。</p><p>第二点，我们可以把这个页面加入到定时测试任务中。APM 平台会以 10 分钟一次的频率对页面进行测试，对多次的测试结果求均值。。优势二是降低了减少了单次测试的不稳定性。</p><p>第三点，我们将一次次孤立的测试结果，关联上了时间维度，形成了页面性能的走势，对页面的性能优化，可以很明显的体现在走势上，更加地有说服力。。</p><p>第四点，我们将孤立的一个页面测试，与组织内的其他页面形成了关联，开发者除了得到一些性能数据以外，也可以更为直观的了解到，自己的页面在组织内到底处于哪个阶段。</p><p>我们可以向着组织内的标杆看齐，在此向古典专区的开发者杨老师致敬，我们需要有榜样的力量。。</p><p>除了上面的优势外，我们还做尝试与 H5 搭建工具合作。
在页面制作完发布上线时，会将 url 与运营人员的邮箱发送的 WebAPM 平台，平台会将页面加入到定时测试中，并将页面的这一次测试结果与组织内的排名发送给运营人员。。</p><p>邮件内会包含上线建议，比如优化超标的图片资源等。。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="一部分总结">一部分总结<a href="#一部分总结" class="hash-link" aria-label="一部分总结的直接链接" title="一部分总结的直接链接">​</a></h4><p>介绍完 WebAPM 的功能后，我们通过对比做一个总结。。</p><p>Lighthouse 的优势是</p><ul><li>无需接入 SDK, 一个 URL 即可测试。</li><li>FCP FMP 等性能指标更贴近用户直观感受。</li><li>性能的评分较为的可信。。</li></ul><p>Lighthouse 的短板是：</p><ul><li>如果依赖手工录入 url，页面可能覆盖不全</li><li>需要模拟页面的前置依赖，如登录等。</li><li>测试的机型较为单一。</li></ul><p>真实用户性能监控的优势是：</p><ul><li>页面覆盖全</li><li>无需模拟，用户正常访问就可以采集到页面性能数据</li><li>机型覆盖广、数据样本量大</li></ul><p>真实用户性能监控的短板是：</p><ul><li>需要接入 SDK, 数据上报存在开销</li><li>性能指标依赖于浏览器的实现</li><li>性能指标与用户的感知存在一定的偏差</li></ul><p>其实 WebAPM 就是一个数据平台，我们可以利用这些数据，参与需求的决策、主动地发起性能优化、推动上下游优化、优化的成果可以成为我们述职、CPP 的材料。。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第二部分-平台的架构演进之路">第二部分 平台的架构演进之路<a href="#第二部分-平台的架构演进之路" class="hash-link" aria-label="第二部分 平台的架构演进之路的直接链接" title="第二部分 平台的架构演进之路的直接链接">​</a></h3><p>我们先介绍一个监控系统的简化模型。。</p><p>首先需要有一个数据采集端，他可是一个 sdk，日志采集器，也可以是一个传感器。</p><p>数据采集后会上报到服务端，服务端对数据做部分的清洗和加工后，写入到时序数据库中。</p><p>当前台需要可视化展示时，服务端会发送聚合查询到数据库，然后加工成可视化数据后，返回给前台做展示。</p><p>在 WebAPM 中，数据采集端就是浏览器 SDK, 服务器就是 Node JS，时序数据库是 Influx DB, 可视化展示是 Antd。</p><p>这个模型中，大家可能对 Influx 最不熟悉了。。</p><p>在介绍后续的架构演进之前，我们首先来介绍下，什么是时序数据库？</p><p>我们以 Influx DB 为例展开介绍。。</p><p>从这个表中，我们可以看到每条记录都包含时间字段，这是时序数据库的特点，并且时序数据库中内置了大量的基于时间的聚合函数。。</p><p>比如求一段时间内均值的 Mean 函数。</p><p>这段 SQL 就是计算过去 5 分钟时间内，tcp 和 load 指标的平均值。。</p><p>我们执行这条 SQL 后，就得到了两个指标的均值。。</p><p>事实上 WebAPM 的加载瀑布图正是通过这条 SQL 来实现的。</p><p>基于上一条 SQL，我们加上 GROUP BY time()，他就可以计算出过去 5 分钟内，每一分钟的平均值。诶，这个就是关联上时间维度的走势啦。。</p><p>事实上，WebAPM 的加载耗时的走势就是通过这条 SQL 来实现的。。</p><p>每次，我们已经掌握了时序数据库的基本用法。。</p><p>OK, 这个监控架构我们也掌握了。。</p><p>但是，我们仍然有些细节需要注意的。</p><p>比如当我们从过去 5 分钟，变为计算 7 天的平均值，并且假设我们要统计的是一个大量流量应用，且 7 天有 1000 万条用户数据记录。。</p><p>我们是否可以简单粗暴的把 5m 改成 7d 呢？来，我们试一下。。</p><p>不好意思，我们真这么做的话，哨兵马上就要报警了，告诉我们内存吃紧了，CPU 要耗尽了。。</p><p>那我们怎么来计算这 1000 万条记录，对他们求均值呢？？</p><p>其中一个解决思路是，把计算均摊到每分钟。。</p><p>原来我们要直接计算 7 天 1000 万个数据点。。</p><p>现在我们不这么做了。。</p><p>我们在收到数据的时候，就定时的，每一分钟，去计算这一分钟的数据聚合结果并把它保存起来。。</p><p>那么这样持续的计算，7 天就会有 10080 个计算结果。。</p><p>当我们需要去计算 7 天的均值时，我们不需要再从 1000 万个原始数据中求均值，我们只要在 10080 个数据中计算即可。。</p><p>数据的规模量大大降低，当然我们还可以再降，比如一小时计算一次，我们不展开讲。。</p><p>那么现在的问题就是如何定时做每分钟的计算呢？？</p><p>实际上 Influx 已经提供了这样的能力，叫做 Continue Query，我们简称 CQ 吧。。</p><p>创建一个 CQ 很简单，就跟查询是一样的。。</p><p>他会定时的，把原始数据，做聚合计算，然后把计算的结果写入到 CQ 表中。。</p><p>现在我们回到刚刚的需求，我们只需要稍作变更，从 CQ 表中请均值即可。。。</p><p>那么引入 CQ 后，我们的存储与计算模型就长这样了。。</p><p>没错，我们已经掌握了时序数据库的高级用法了。</p><p>但是随着应用接入越来越多，存入的原始数据就越来越多。。</p><p>Influx 会对存入的数据建立内存索引，索引的规模可以用 Series 这个指标来衡量，通过官方文档的图片，我们可以看到，Series 数量级与内存开销的关系图。。</p><p>我们当前 Series 的数量级已经达到了 200 万，云主机上的内存压力是蛮大的。。</p><p>我们如何来缓解这个问题呢？</p><p>其实我们可以在写入数据库前就将原始的数据做聚合，只存入聚合后的数据，那么就可以缓解 DB 的压力。。</p><p>现在的问题变成，如何在存入数据数据库前做数据的聚合。。</p><p>我们可以直接在 Node JS 上做聚合计算吗？</p><p>如果我们的 Node JS 是单机部署的话，只要在 Node JS 上做一个 1 分钟的数据窗口，将聚合后的数据写入数据库，这样的模型看起来好像也是挺合理的。。</p><p>但是如果我们的 NodeJS 是集群部署。。</p><p>我们如何来协调每一台机器上的数据窗口，进行同步、进行数据结果的汇总，设计将变得复杂。。</p><p>如果时间窗口由 1 分钟变成 1 个小时、甚至 1 天，Node JS 也会成为瓶颈。。</p><p>如果有一个做聚合计算的中间件就好了。。Flink 就是干这件事的。。Flink 很牛，但是在这里，我们先简单把他理解成做聚合计算的中间件。。</p><p>我们来看下引入 Flink 后的数据流。。</p><p>首先 SDK 将数据上报到 NodeJS, NodeJS 对数据做清理和加工后，发布到消息队列的原始数据队列里。。Flink 订阅了这个数据，会从队列里不断地取出数据，并根据配置的时间窗口做集合计算，然后将计算后的结果写到计算结果队列中，NodeJS 订阅了这个队列，在收到数据后，将聚合的结果写入到 InfluxDB。</p><p>后续前台需要查询数据，仍然是从 InfluxDB 中读取。。</p><p>Flink 很牛，那我们应该怎么玩呢？是要自己搭吗？不用，我们现在已经有这样的基础设施。。其他部门可能也都有。。</p><p>云音乐 Flink 计算平台-Magina, 在上面我们可以配置一个计算任务的数据输入源，数据输出源，和对数据的操作。。</p><p>输入与输出我们这边就是消息队列了。</p><p>操作可以通过写 SQL 或者开发一个 Java JAR 包的方式。。</p><p>我们这里演示的是 SQL。</p><p>我们只要知道这个平台可以做聚合计算、并且操作很便捷就可以。。具体的语法可以后面再了解。。</p><p>那引入 Flink 后有哪些优势呢？</p><p>首先我们降低了 Influx DB 的存储与计算压力。。
那可能有同学会疑问，你自己的压力小了，别人的压力大了啊，你这是甩锅。。</p><p>不是这样的，人家 Flink 平台，肯定是可以动态扩缩容的，可以动态变更算力，我们把计算统一到他这里管理，我们的 Influx 就不需要那么高的配置，对于整个组织来说，是节约资源。。</p><p>第二个优势是 Flink 可以通过配置自定义聚合函数，那么我们对数据的加工能力将不受限于 Influx DB 内置的聚合函数。。</p><p>第三个优势是
在使用 Influx 社区单机版的前提下，我们整个系统的架构更具有弹性的高可用方案。
有了消息队列以后，我们不需要为了应对峰时的流量而无限提高 Influx 的配置，而且 Influx 挂掉后，数据依然是在聚合并写到消息队列中。。等 Influx 恢复后，数据可以继续写入，挂掉这段时间的数据不会丢失。。</p><p>OK, 这就是为大家介绍的通用的监控架构。。我们的时序数据库可以是 Influx DB 也可以换成 ES。
前端展示我们可以自己开发，也可以使用开源的可视化 Grafana，无需开发，只要通过配置就可以做可视化展示。。</p><p>这个监控架构有什么用呢？？
其实后端提供的中间件、微服务，都会对服务做监控，以保障服务的可靠性。。那么随着 Node JS 的大力发展，我们前端后续可能也会提供出一些微服务，那么这些服务的保障就需要监控。。如果我们部门的基础设施，无法满足我们的需求。。那么我们就可以自己搭一个监控。。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="未来规划">未来规划<a href="#未来规划" class="hash-link" aria-label="未来规划的直接链接" title="未来规划的直接链接">​</a></h3><p>最后我们聊一聊未来的规划，</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="数据精细化展示">数据精细化展示<a href="#数据精细化展示" class="hash-link" aria-label="数据精细化展示的直接链接" title="数据精细化展示的直接链接">​</a></h4><p>我们当前的真实用户数据展示中，会有数据的波动，其中有一部分原因可能是极端性能状况引起。</p><p>后续我们引入 Flink 后，可以通过自定义的聚合函数，将头尾 5%的极端数据剔除后请均值。。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="性能对比">性能对比<a href="#性能对比" class="hash-link" aria-label="性能对比的直接链接" title="性能对比的直接链接">​</a></h4><p>我们现在通过 Lighthouse 的组织排名，可以比较直观地了解到自己开发的页面的性能水平，与其他页面的差距等。。</p><p>但是真实用户性能这块，我们应用的数据仍然是比较孤立的，开发者其实比较难以知道，自己的应用性能到底处于什么水平，是好是差。。</p><ul><li><p>后续会考虑将组织内的性能数据，建立性能分档，每个档位对应一个分数，计算出应用的评分。。</p></li><li><p>将相同业务场景的应用进行对比，如同样都是云音乐小程序、同样都是 SSR 的架构</p></li><li><p>并且基于业务场景，给出针对性的优化建议。。</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="influx-单机版问题">Influx 单机版问题。<a href="#influx-单机版问题" class="hash-link" aria-label="Influx 单机版问题。的直接链接" title="Influx 单机版问题。的直接链接">​</a></h4><p>实际上，我们当前在用的是饿了么的 Influx Proxy 方案，可以通过配置成数据双写，来做数据的备份，以达到高可用的目的。。</p><p>也可以配置成数据分片，来提高整个集群的存储计算能力。。</p><p>但这个还不是最完美的。。杭研的 NTSDB 是真 Influx 集群，后续我们可能会迁移到 NTSDB 来。。</p><p>另外也借着这个机会，感谢 NTSDB 的作者，范欣欣同事，他对 WebAPM 的架构改进提供了指导。。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h3><p>首先我介绍了平台的定位及已有的功能，按照监控手段划分，平台可以分为 2 个方向。</p><p>其次我介绍了平台的架构演进，为大家介绍了通用的监控系统技术栈和其中的难点与解决思路。。。</p><p>最后我介绍了平台后续的规划，包括精细化数据分析、应用性能对比和 Influx 集群迁移。</p><p>感谢大家的耐心聆听，本次分享就到这里。。最后是交流时间。。</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/presentation/tags/web">web</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/presentation/tags/performance">performance</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/presentation/tags/apm">apm</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/presentation/web-vitals"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">谷歌体验度量指标集 Web Vitals</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/presentation/performance-basic"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">页面渲染性能优化基础</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#第一部分" class="table-of-contents__link toc-highlight">第一部分</a></li><li><a href="#第二部分-平台的架构演进之路" class="table-of-contents__link toc-highlight">第二部分 平台的架构演进之路</a></li><li><a href="#未来规划" class="table-of-contents__link toc-highlight">未来规划</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 kkdev163. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.59883482.js"></script>
<script src="/assets/js/main.03c6f4a0.js"></script>
</body>
</html>