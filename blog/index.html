<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Blog | kkdev163</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kkdev163.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kkdev163.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kkdev163.github.io/blog"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | kkdev163"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kkdev163.github.io/blog"><link data-rh="true" rel="alternate" href="https://kkdev163.github.io/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://kkdev163.github.io/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="kkdev163 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="kkdev163 Atom Feed">



<link rel="alternate" type="application/rss+xml" href="/presentation/rss.xml" title="kkdev163 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/presentation/atom.xml" title="kkdev163 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.5f14fa28.css">
<link rel="preload" href="/assets/js/runtime~main.69c15619.js" as="script">
<link rel="preload" href="/assets/js/main.8e1951b7.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">kkdev163</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">文章</a><a class="navbar__item navbar__link" href="/presentation">演讲</a><a class="navbar__item navbar__link" href="/resume">关于我</a><a href="https://github.com/kkdev163" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">最近文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tsdb-part2">Corona 技术专题-时序数据分析(下)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tsdb-part1">Corona 技术专题-时序数据分析(上)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/elasticsearch-basic">ES(ElasticSearch) 搜索基本概念简介</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/lighthouse">Lighthous 测试内幕</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/wapm-storage">前端性能监控平台-存储与计算架构展望</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/sentry-sshfs">Sentry平台-为Docker Swarm集群添加SSHFS分布式文件存储</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="一. 前言"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/tsdb-part2">Corona 技术专题-时序数据分析(下)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-04-28T00:00:00.000Z" itemprop="datePublished">2023年4月28日</time> · <!-- -->阅读需 17 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/34838245?v=4" alt="kkdev163" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">kkdev163</span></a></div><small class="avatar__subtitle" itemprop="description">Web 全栈开发工程师@NetEase</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一-前言">一. 前言<a href="#一-前言" class="hash-link" aria-label="一. 前言的直接链接" title="一. 前言的直接链接">​</a></h3><p>在 <a href="/blog/tsdb-part1">Corona 技术专题-时序数据分析(上)</a>中，我们介绍了什么是时序数据分析、时序数据库的特点 和 经典时序数据库 InfluxDB。本篇文章将继续围绕时序数据分析专题，介绍 ElasticSearch、ClickHouse 两款数据库在时序分析上的应用。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="二-elasticsearch">二. ElasticSearch<a href="#二-elasticsearch" class="hash-link" aria-label="二. ElasticSearch的直接链接" title="二. ElasticSearch的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21-简介">2.1 简介<a href="#21-简介" class="hash-link" aria-label="2.1 简介的直接链接" title="2.1 简介的直接链接">​</a></h4><p>Elasticsearch 是一款基于 Apache Lucene 的分布式搜索和分析引擎，用于全文检索、日志分析、数据可视化等场景。它支持实时搜索、数据聚合、自动化分片和复制等功能，并提供了 RESTful API 和丰富的插件生态系统。Elasticsearch 被广泛应用于企业级搜索和日志分析等领域。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="22-在-corona-中的应用场景">2.2 在 Corona 中的应用场景<a href="#22-在-corona-中的应用场景" class="hash-link" aria-label="2.2 在 Corona 中的应用场景的直接链接" title="2.2 在 Corona 中的应用场景的直接链接">​</a></h4><p>在设计 Corona 平台时，我们引入 ES 的主要目的是用于 存储异常监控的原始日志，并借助 ES 的全文检索能力，提供丰富、灵活的日志搜索功能。</p><p>下图为 Corona 的搜索面板，在此处我们意图搜索包含 undefined 信息的错误日志。</p><img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27195122214/ecce/e54c/d851/cacd03354eaae9fa27a3777cb01a88f0.png" width="400" class="img_ev3q">下图为 Corona 的搜索结果列表，展示了包含 undefined 错误信息的 Issue。<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27195252659/b9d4/8b16/d67f/430607bd6805c276d19df601b0d7ff43.png" width="400" class="img_ev3q"><p>关于 ES 搜索的概念，在这篇文章中不作更多展开，感兴趣的读者可以参考<a href="https://kms.netease.com/article/52242" target="_blank" rel="noopener noreferrer">ES(ElasticSearch) 搜索基本概念简介</a>。</p><p>除了日志的搜索功能外，Corona 也希望为用户展示异常发生的时序趋势图。由于原始日志的存储我们已经使用了 ES 进行存储，在设计时序分析功能实现时，我们其实是有两条技术实现路线可供选择:</p><ol><li>将原始日志另写入一份至消息队列 -&gt; Flink 聚合 -&gt; InfluxDB</li><li>使用 ES 的聚合能力，基于原始日志直接做时序数据分析。</li></ol><p>考虑到架构的简洁、减少依赖等因素，并参考了 ES 与 InfluxDB 的性能对比文章后，我们最终选择了方案二。 以下是使用 ES 做的一些时序分析功能演示:</p><p>下图为应用整体的异常趋势图:
<img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27195565010/e546/0e4f/6ef9/256ae76ed1037ae0be842c3e05a899bb.png" class="img_ev3q"></p><p>下图为单条 issue 的异常趋势图:
<img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27195581099/6821/aa64/e406/c29529b8e3608cfeaeff0f6b137c900b.png" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23-表结构设计及查询示例">2.3 表结构设计及查询示例<a href="#23-表结构设计及查询示例" class="hash-link" aria-label="2.3 表结构设计及查询示例的直接链接" title="2.3 表结构设计及查询示例的直接链接">​</a></h4><p>ES 在写入数据前，不要求建立表结构。ES 会根据写入的数据自动推断数据类型进行存储。但为了避免类型的错误推断导致后续查询功能不符合预期，建议是在写入数据前，对表结构进行约束。</p><p>ES 对表结构进行约束的方式是创建模板。模板中可包含 索引匹配规则 (可理解为表名)，表中的数据结构类型。</p><p>下面我们创建一个演示的模板，模板中的索引包含了 5 个字段</p><ul><li>project_id: 应用 ID，类型为 long</li><li>issue_id: 聚合错误 ID, 类型为 long</li><li>os: 上报操作系统，类型为 keyword</li><li>ts: 上报时间，类型为 date</li><li>error_obj: 错误详情对象，JSON 类型，JSON 中包含 message 字段，message 为文本类型，支持分词检索。</li></ul><div class="language-JSON codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-JSON codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PUT _template/template_web_demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;indx_patterns&quot;: [&quot;web_demo_*&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;mappings&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_doc&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;project_id&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;type&quot;: &quot;long&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;issue_id&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;type&quot;: &quot;long&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;os&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;type&quot;: &quot;keyword&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;ts&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;type&quot;: &quot;date&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;error_obj&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 &quot;message&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     &quot;type&quot;: &quot;text&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     &quot;fields&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;keyword&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;type&quot;: &quot;keyword&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;ignore_above&quot;: 256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下是一些示例数据：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">project_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">issue_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">os</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;iphone&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2023-04-27 15:00:00&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">error_obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Cannot read properties of undefined (reading &#x27;providerLog&#x27;)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">project_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">issue_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">os</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;android&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">ts</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2023-04-27 15:01:00&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">error_obj</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;e.forEach is not a function&#x27;)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查询示例: 查询项目 id 为 1 的所有 issue 的最近 7 天每日上报量走势</p><div class="language-JSON codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-JSON codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;query&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bool&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;filter&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;bool&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;must&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { // 指定查询的项目id 为 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;term&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;project_id&quot;: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { // 指定查询时间范围 &gt;= 2023-04-21 00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;range&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;gte&quot;: 1682006400000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            { // 指定查询时间范围 &lt;= 2023-04-27 23:59:59</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;range&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ts&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;lte&quot;: 1682611199000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;aggs&quot;: { // 聚合，按 issue_id 字段做聚合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;issueId&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;terms&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;field&quot;: &quot;issue_id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;aggs&quot;: { // 子聚合，按时间1天粒度做聚合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;series&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;date_histogram&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;field&quot;: &quot;ts&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;interval&quot;: &quot;1d&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;time_zone&quot;: &quot;+08:00&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;size&quot;: 0, // 只统计聚合结果，不返回原文档</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对于首次接触 ES 的同学来看，这个查询条件看上去会比较地复杂。上面的查询如果用 InfluxDB SQL 的话其实就是:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT COUNT()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM `web_demo`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  project_id = 1 AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  time&gt;=1682006400000 AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  time &lt;=1682611199000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GROUP BY issue_id, time(1d);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-数据读写架构">2.4 数据读写架构<a href="#24-数据读写架构" class="hash-link" aria-label="2.4 数据读写架构的直接链接" title="2.4 数据读写架构的直接链接">​</a></h3><blockquote><p>本节我们只介绍 ES 在 Corona 时序数据场景下的应用层架构</p></blockquote><p><strong>1) 基于原始日志做时序分析</strong></p><p>Corona 平台的异常日志原始日志由异常日志清洗服务做预处理后批量写入 ES。可视化管理后台在后续可直接请求 ES 做时序数据分析。
<img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27201538834/5897/e416/6bb2/5282867cd6389055ddaf92e95df0bab2.png" class="img_ev3q">
<strong>2) 基于聚合数据做时序分析</strong></p><p>在 Corona 的告警场景，考虑到查询聚合表会比查询原始表有更高的性能，并且为了方便追溯告警的历史走势，我们在应用层配置了定时任务做分钟级的数据聚合，告警任务在执行时，直接读取分钟级聚合表。
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27201542231/258d/21ab/a664/34ba5a29faff6ea0a4817507acaf6646.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="25-存在的痛点">2.5 存在的痛点<a href="#25-存在的痛点" class="hash-link" aria-label="2.5 存在的痛点的直接链接" title="2.5 存在的痛点的直接链接">​</a></h3><p>Corona 使用 ES 做时序分析的场景相对来说还比较有限。对于 ES 在时序分析下的性能，是否存在瓶颈，尚未有深入的探索。我们的痛点主要是集中在使用姿势上。</p><p>通过 2.3 节 的示例，读者不难发现，在时序分析场景，ES 查询的请求体的书写 和 理解 相对于 InfluxDB 来说，具有一定的复杂度。 如果我们的项目需要用到 ES 来做时序分析，建议是在应用层封装一些 Utils 工具类，协助做请求体生成 和 数据解析。NodeJS 环境下推荐基于 <a href="https://www.npmjs.com/package/bodybuilder" target="_blank" rel="noopener noreferrer">bodybuilder</a> 做上层的封装。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="三-clickhouse">三. ClickHouse<a href="#三-clickhouse" class="hash-link" aria-label="三. ClickHouse的直接链接" title="三. ClickHouse的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="31-clickhouse-简介">3.1 ClickHouse 简介<a href="#31-clickhouse-简介" class="hash-link" aria-label="3.1 ClickHouse 简介的直接链接" title="3.1 ClickHouse 简介的直接链接">​</a></h4><p>ClickHouse 是 OLAP(on-Line Analytic Processing) 联机分析处理数据库。在数据分析时，可直接对亿级原始日志做在线的实时聚合计算，并且能在秒级给出聚合结果。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="32-在-corona-中的应用场景">3.2 在 Corona 中的应用场景<a href="#32-在-corona-中的应用场景" class="hash-link" aria-label="3.2 在 Corona 中的应用场景的直接链接" title="3.2 在 Corona 中的应用场景的直接链接">​</a></h4><p>Corona 在引入 ClickHouse 之初，是为了补充原有 性能监控架构 的分析能力(如多维的分位数 P50、P95 统计能力)，随着我们对 ClickHouse 使用经验的积累 和 特性原理的认识，我们发现在 Corona 的性能分析应用场景上，ClickHouse 能够完全取代 Flink 、InfluxDB 的作用。并且整体的架构更加简洁，数据分析的方式也更加灵活、轻便。</p><p>目前 Corona 上的建设的性能监控指标，已完全由 ClickHouse 提供存储与数据分析的能力。主要的分析功能有:</p><p>1). 基于上报数据维度字段，提供多维的组合筛选能力
2). 在线实时聚合计算，统计 平均值、分位数、PV、UV 走势</p><p><img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27203697679/8f89/97b2/e027/7a308942880eee04a2ab0c2cf155e706.png" class="img_ev3q">
3). 按照某个维度聚合，对比不同维度值的走势</p><p><img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27203727019/b63c/a464/52d4/c878914b569e737d0f99c7b283d811f0.png" class="img_ev3q">
4). 查看不同维度值的占比
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27203746572/18c9/d7bb/79ff/9379c160676d61043f15a56bf2f4795f.png" class="img_ev3q">
5). 统计指标值的详细分布情况
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27203752779/7787/66d2/0044/82ac157d3e60894c677232dda1c5a091.png" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="33-表结构设计及查询示例">3.3 表结构设计及查询示例<a href="#33-表结构设计及查询示例" class="hash-link" aria-label="3.3 表结构设计及查询示例的直接链接" title="3.3 表结构设计及查询示例的直接链接">​</a></h4><p>ClickHouse 在写入数据前，需要使用建表语句创建表结构。以 ReactNative 启动耗时监控为例, 以下为示例的表结构:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE rn_monitor_cold_boot_stage_local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `appName` String, -- 应用名，如 云音乐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `osName` String, -- 操作系统名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `appVersion` String, -- 应用版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `rnModuleName` String, -- ReactNative 模块名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `deviceTag` String, -- 设备性能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `uploadTime` DateTime, -- 日志到达服务端时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `uid` String, -- 用户 uid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `stageName` String, -- 阶段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `stageCost` Float32, -- 阶段耗时</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENGINE = MergeTree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION BY (appName, osName, toYYYYMMDD(uploadTime))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY (rnModuleName, uploadTime)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TTL uploadTime + toIntervalDay(90)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SETTINGS index_granularity = 8192, use_minimalistic_part_header_in_zookeeper = 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在示例表结构中，uploadTime 为时间列， stageCost 为数值列，其他字段都为维度列。</p><p>MergeTree 是 ClickHouse 中最重要的表引擎，这种表引擎的特点是，数据在批量写入时，ClickHouse 会将数据写入新的临时分区中, ClickHouse 会在后台对 临时分区 与 已有的数据分区 做 Merge，以此来提高数据的写入性能。</p><p>PARTITION BY 数据的分区策略，示例表以 appName, osName, 上报时间(天) 所组成的联合键 建立分区。 ClickHouse 会为每个分区建立一个目录，合理的分区策略，可以让 ClickHouse 在后续查找数据时，直接选中分区目录，大大降低扫描的数据行数。</p><p>ORDER BY 数据的排序键，ClickHouse 默认会为排序键建立索引。</p><p>TTL 数据自动过期时间，90 天。</p><p>index_granularity 索引粒度为 8192 行(可理解为 8192 行数据，建立一条索引)。</p><p>示例数据如下:</p><div class="language-JSON codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-JSON codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;appName&quot;: &quot;music&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;osName&quot;: &quot;android&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;appVersion&quot;: &quot;8.9.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;rnModuleName&quot;: &quot;rn-playlistrank&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;deviceTag&quot;: &quot;高端机&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;uploadTime&quot;: &quot;2023-04-27 12:00:00&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;uid&quot;: &quot;9999999&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;stageName&quot;: &quot;render&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;stageCost&quot;: 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查询示例:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    toStartOfDay(uploadTime) as &quot;time&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    avg(stageCost) AS &quot;avg&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quantiles(0.5, 0.9)(stageCost) AS &quot;quantiles&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count() AS &quot;pv&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uniq(uid) AS &quot;uv&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM rn_monitor_cold_boot_stage_shard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   uploadTime&gt;=1682006400 AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   uploadTime&lt;=1682611199 AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   stageName=&#x27;render&#x27; AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   rnModuleName=&#x27;rn-playlistrank&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GROUP BY toStartOfDay(uploadTime)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY toStartOfDay(uploadTime) ASC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查询结果示例:
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27206521249/9c51/5849/7d58/8e6680e9d7da26baad1b1941e7ad81af.png" class="img_ev3q"></p><p>以上的查询示例，包含了 平均值、分位值、PV、UV 的统计，是 Corona 性能监控分析最基础 SQL。其他的性能分析都是基于该 SQL 的变种。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="34-数据读写架构-及-配套建设">3.4 数据读写架构 及 配套建设<a href="#34-数据读写架构-及-配套建设" class="hash-link" aria-label="3.4 数据读写架构 及 配套建设的直接链接" title="3.4 数据读写架构 及 配套建设的直接链接">​</a></h4><p>得益于 ClickHouse 的高性能 (举例来说，当上述的示例 SQL 的扫描数据量级达到 6 亿行时，也仅需 2 秒就可以完成数据分析），
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27206860033/532e/16ce/5261/fe4aa4e5ecd9abd708917bd8ba3d0e11.png" class="img_ev3q">
在绝大多数的场景，我们可以直接使用 ClickHouse 直接对原始数据做实时聚合分析，这也使得我们的性能分析架构变得简洁。</p><p><strong>数据写入</strong>
在数据写入前，我们使用自建的「性能日志处理服务」订阅不同的 性能日志，每个消费者订阅一种日志类型，在预处理后，会根据每张表的建表分区规则，在服务端对数据做预分区，每个分区的数据单独批量写入 ClickHouse。以此达到 批量写入 同时又减少 ClickHouse 在后台对数据做再次分区的开销，提高写入性能。</p><p>数据批量写入时，使用了自建的集群版 ClickHouse NodeJsClient，做数据 Schema 校验 并 随机请求集群中的 Node 达到数据均匀分片的目的。
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27207198216/af50/824e/2c70/8b35903bd05edb81a90aaa0a8272382e.png" class="img_ev3q">
<strong>数据查询</strong>
细心的读者可能发现了，我们在上面示例中，我们所建的示例表，是以 <code>_local</code> 结尾，而我们的查询示例表是以 <code>_shard</code> 结尾。</p><p>事实上，我们在建表时，会同时创建 local 表 与 shard 表。在数据写入时，性能日志处理服务是直连每个 ClickHouse node 向 local 表写入数据。可以理解为每个 node 只保存了 整个完整表的 1/4 行的数据。在查询时，查询任意一个节点的 shard 表，ClickHouse 会在后台自动汇总 4 个 node 的全部数据做分析。
<img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27207917384/122c/e08b/999b/5008a4c20dcc5edabb16e182b21df83f.png" class="img_ev3q">
注: 该图 local 表中的行号仅用于示意分片的数据量级，并非实际的存储或索引行号。</p><p>在自建的性能日志处理服务 和 可视化后台 上，我们也加入了一些监控指标，来观测 ClickHouse 集群的读写健康度。</p><p><strong>写入侧监控:</strong></p><ul><li>每分钟 批量写入的请求数</li><li>每分钟 批量写入的日志数</li><li>每分钟 不同分区的写入日志数</li><li>每分钟 忽略的日志数(Schema 校验不通过)
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27207965120/4a7d/d9c6/43d7/396230093cd4f2e5a2f6f45fa0bf8363.png" class="img_ev3q"></li><li>数据消费的延时</li><li>数据批量转换耗时</li><li>数据批量转换条数
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27207977929/ca03/235f/f6ad/052ffea26bf69274158d7da4c08c531d.png" class="img_ev3q"></li><li>数据分区转换并写入 ClickHouse 耗时</li><li>ClickHouse 写入请求耗时
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27207991931/70c9/2b9c/ed2f/99cf455cbf0d5c155ca48bb1646d69d2.png" class="img_ev3q"></li></ul><p><strong>查询侧监控</strong>:</p><ul><li>每分钟总查询次数</li><li>每分钟平均查询耗时</li><li>慢查询 SQL 详情
<img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/27208225232/e89a/eead/4021/d81fd0e8f671586b7576401debacd15c.png" class="img_ev3q"></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="35-存在的痛点">3.5 存在的痛点<a href="#35-存在的痛点" class="hash-link" aria-label="3.5 存在的痛点的直接链接" title="3.5 存在的痛点的直接链接">​</a></h4><p>ClickHouse 在 Corona 的性能分析场景满足了我们绝大多数的诉求，如果非要让笔者想一个痛点的话，那可能是缺少像 InfluxDB 一样的 CQ ( Continue Query) 能力。什么情况下需要 CQ 呢？</p><p>ClickHouse 虽然具有强大的实时在线分析能力，但是他的处理性能也是有资源开销的。在机器资源有限的前提下，如果需要做时间跨度大，数据量级超几百亿的分析，也是有相当大的资源开销和等待时间的。</p><p>举例来说，在 Corona 比较分析 App 版本性能走势场景时，由于 App 发版时间跨度大，每个版本仅存在一段时间的高峰流量期，如果需要客观地对比每个 App 的性能，需要让每个版本的样本量尽可能大，我们如果还是选择在线分析的话，就需要把 时间跨度拉到好几个月。此时数据分析的等待时间就会特别长。</p><p>为了解决等待耗时长的问题，我们还是转为离线分析的思路，在应用层，每日对 Top3 日活的版本做性能归档快照。在分析 App 版本走势时，使用归档快照数据做分析。</p><p>如果 ClickHouse 原生具备 InfluxDB 的 Continue Query 能力，可能实现起来会相对容易些。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="36-更多-clickhouse-资料">3.6 更多 ClickHouse 资料<a href="#36-更多-clickhouse-资料" class="hash-link" aria-label="3.6 更多 ClickHouse 资料的直接链接" title="3.6 更多 ClickHouse 资料的直接链接">​</a></h4><ul><li><a href="https://kms.netease.com/article/48727#1max_concurrent_queries" target="_blank" rel="noopener noreferrer">ClickHouse 使用实践与规范</a></li><li><a href="https://www.cnblogs.com/traditional/p/15218743.html" target="_blank" rel="noopener noreferrer">ClickHouse 中最重要的表引擎：MergeTree 的深度原理解析</a></li><li><a href="https://docs.popo.netease.com/lingxi/3d876d69fb66428d9b23e09f67ac099b#edit" target="_blank" rel="noopener noreferrer">监控体系引入 ClickHouse 调研</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/时序数据库、clickhouse、es">时序数据库、clickhouse、es</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="一. 前言"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/tsdb-part1">Corona 技术专题-时序数据分析(上)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-03-16T00:00:00.000Z" itemprop="datePublished">2023年3月16日</time> · <!-- -->阅读需 16 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/34838245?v=4" alt="kkdev163" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">kkdev163</span></a></div><small class="avatar__subtitle" itemprop="description">Web 全栈开发工程师@NetEase</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一-前言">一. 前言<a href="#一-前言" class="hash-link" aria-label="一. 前言的直接链接" title="一. 前言的直接链接">​</a></h2><p>在 Corona 平台的技术体系建设中，时序数据库承担了时序数据的「存储」和「分析」 的关键作用。本系列文章将分为上、下 两篇 介绍三款数据库在 Corona 时序分析场景下的应用。 上篇介绍 InfluxDB ，下篇介绍 ElasticSearch、ClickHouse 。 通过本系列文章的阅读，您将掌握时序数据库的基本概念、特点，从而帮助您更好地理解 Corona 的设计与使用。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二-时序数据库简介">二. 时序数据库简介<a href="#二-时序数据库简介" class="hash-link" aria-label="二. 时序数据库简介的直接链接" title="二. 时序数据库简介的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-时序数据分析">2.1 时序数据分析<a href="#21-时序数据分析" class="hash-link" aria-label="2.1 时序数据分析的直接链接" title="2.1 时序数据分析的直接链接">​</a></h3><p>时序数据是按时间顺序排序的一组数字序列，它可以反应某一现象的变化规律。在我们的日常生活中时序数据随处可见，如「天气预报时序走势图」它反映了温度随时间变化的规律; 如「油价时序走势图」 它反应了油价随时间变化的规律:</p><p><img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/25814972757/24f6/3597/6072/776369703f0b6cee8911e1e70b59f14c.png" class="img_ev3q"></p><p>在应用监控领域，时序走势图 能够反应「应用健康度」随时间变化的趋势，是用户最为关注的几类图表之一:
<img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/25815108848/035d/b85c/4202/b119c485590f3ba77ce617b1c764934e.png" class="img_ev3q"></p><p>除了分钟级粒度的数据，有时也需要按 「小时级」、「天级」 粒度查看走势数据：</p><p><img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/25815134080/fb90/76ff/2430/35b3938287844f0789251a69bebef9b5.png" class="img_ev3q"></p><p>除了整体维度，用户也可以按某个特征维度对走势数据做分类(下表对比了不同档次机型的加载时间走势):
<img loading="lazy" src="https://p5.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/25815159791/87d8/db18/29f8/f11d5e43457ebfbbf0ce1505be9ac969.png" class="img_ev3q"></p><p>对时序数据做上述分析的过程我们可以称其为时序数据分析。便于存储时序数据、提供时序数据分析能力的数据库我们称其为时序数据库。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-时序数据库特点">2.2 时序数据库特点<a href="#22-时序数据库特点" class="hash-link" aria-label="2.2 时序数据库特点的直接链接" title="2.2 时序数据库特点的直接链接">​</a></h3><ol><li>时间列</li></ol><p>时序数据库的主要查询和分析能力与「时间」字段有较大关联，所以在设计时序数据库的表结构时 通常会将 「时间」字段作为「索引」字段。</p><p>这样的设计方便应用快速筛选出目标范围的时序数据，并且时序数据库也提供了一系列 「时间」相关的工具函数，方便我们在时序数据上按不同的时间粒度(如 分钟、小时、天 )做聚合分析。</p><ol start="2"><li>维度列</li></ol><p>在储存时序数据时，通常会附带上这条数据的维度信息，维度信息可以在后续分析时作为 过滤 或 聚合的条件。如 天气时序数据中，会有 「城市」维度，维度值为 北京、上海、杭州 等。 油价时序数据中，会有「汽油标号」维度，维度值为 92、95、98 等。</p><p>在表结构设计时通常高频的查询 和 聚合 维度也是建议作为「索引」字段存储。</p><ol start="3"><li>数值列</li></ol><p>时序数据的数值，如天气时序数据中的 「温度值」、油价时序数据中的「价格」，会作为数值列进行存储。</p><p>时序数据库会提供一系列的工具函数对数值列做分析计算。常见的分析函数有：</p><ul><li>avg 求平均值</li><li>max 求最大值</li><li>min 求最小值</li></ul><p>组合以上的功能特点，我们可以运用时序数据库就做一些常见的时序分析，如:</p><p>查询 2023 年 2 月份杭州每天的平均温度值走势 SQL：</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT toStartOfDay(time), avg(degree)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM table_temperature</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time&gt;=&#x27;2023-02-01&#x27; AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time&lt;&#x27;2023-03-01&#x27; AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    city=&#x27;杭州&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GROUP BY toStartOfDay(time)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查询 最近 10 年各品类汽油每年的平均价格走势 SQL:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT toYear(time), model, avg(price)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM table_gas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time&gt;=&#x27;2013-01-01&#x27; AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time&lt;&#x27;2023-01-01&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GROUP BY toYear(time), model</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>数据过期时间 TTL</li></ol><p>时序数据的另一个特点是关注近期的数据，距离当前比较久远的数据相对来说没那么重要，有时出于存储容量的考虑，我们甚至会希望自动删除老旧的数据。</p><p>时序数据库一般会提供 TTL (Time To Live) 功能，在设计数据库表结构时，一般会根据数据表的聚合粒度设置相应的过期时间。如 原始数据 或 分钟级的数据 保留 30 天， 小时 或 天级的 聚合数据 保留 1 年。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三-influxdb">三. InfluxDB<a href="#三-influxdb" class="hash-link" aria-label="三. InfluxDB的直接链接" title="三. InfluxDB的直接链接">​</a></h2><p>介绍完了时序数据分析与时序数据库的特点，我们首先来看 InfluxDB 在 Corona 中的应用。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-简介">3.1 简介<a href="#31-简介" class="hash-link" aria-label="3.1 简介的直接链接" title="3.1 简介的直接链接">​</a></h3><p><a href="https://docs.influxdata.com/influxdb/v2.6/get-started/" target="_blank" rel="noopener noreferrer">InfluxDB</a> 是一款经典的开源时序数据库。在 InfluxDB 中有几个常用的概念</p><ol><li>measurement</li></ol><p>measurement 是 InfluxDB 中的数据表。一张 measurment 中可包含 一个时间列(time column)、多个维度列(tag column)、多个数值列(field column)。</p><p>用户无需手动使用 CREATE 语句创建 measurment，InfluxDB 会在写入的数据时动态创建 measurement、动态新增维度列与数据列。</p><ol start="2"><li>tag</li></ol><p>tag column 是 InfluxDB 中的维度列，InfluxDB 会为所有的维度列建立索引。在设计表结构时，我们需要将经常作为查询条件、聚合条件的字段作为 tag 列进行存储。</p><p>在设计 tag 列时，需要特别留意的是 tag 列的潜在值是要可收敛的，不能是无限增长的。</p><p>举几个对比的例子:
Good Case| Bad Case
---|---
监控页面的域名(location.host) | 监控页面的 URL (location.href)
设备操作系统 | 设备 UUID
歌曲文件类型 | 歌曲 ID</p><p>原因是 InfluxDB 为了 查询/写入 性能，会为所有的 tag 列建立索引，而索引的规模直接影响内存的占用开销。若 tag 列设计不合理，极易造成 InfluxDB 的内存持续增长甚至出现 OOM 的情况。</p><ol start="3"><li>field</li></ol><p>field column 是 InfluxDB 中的数值列，数据类型可以是 数字、字符串型。在设计表结构时，我们需要将未来用于 数值统计分析 的字段作为 field 列存储。一些不常作为查询条件、无法收敛的额外信息也可以放到 field 列进行存储。</p><ol start="5"><li>retention policy</li></ol><p>RR(retention policy) 数据保留策略，是 InfluxDB 的 TTL 实现机制。RP 可以在创建数据库后随时新增、变更。我们可以为一个数据库创建多个 RP。如:</p><ul><li><code>create retention policy one_week on apm_log duration 7d default;</code></li><li><code>create retention policy one_year on apm_log duration 365d;</code></li></ul><p>在数据写入时，我们可以根据数据的重要度、时效性 显示地指定使用哪个 RP，数据在超过保留时间后，就会自动删除。</p><ol start="6"><li>continue query</li></ol><p>CQ(continue query) 持续查询，可用于 数据归档、降采样。举例来说当我们采集的原始数据是分级的，我们可以使用 CQ 功能，将原始表的数据聚合写入小时级表。</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE CONTINUE QUERY &quot;cq_event&quot; ON &quot;apm_log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SELECT SUM(&quot;pv&quot;) as pv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INTO &quot;one_year&quot;.&quot;cq_hour_event&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FROM &quot;one_week&quot;.&quot;cq_minute_event&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GROUP BY time(1h), *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">END</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建完 CQ 任务后，InfluxDB 就会每小时执行一次聚合任务。这样后续在查询的时候，可以直接从聚合查询，加快查询速度。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-在-corona-中的应用场景">3.2 在 Corona 中的应用场景<a href="#32-在-corona-中的应用场景" class="hash-link" aria-label="3.2 在 Corona 中的应用场景的直接链接" title="3.2 在 Corona 中的应用场景的直接链接">​</a></h3><p>InfluxDB 在 Corona 平台中主要有以下几个应用场景:</p><ul><li><ol><li>存储 C 端用户上报的 访问量、性能 等「预聚合结果」数据</li></ol></li><li><ol start="2"><li>存储平台自身运行健康度的 「原始」数据</li></ol></li></ul><ol><li>存储「预聚合结果」数据</li></ol><p>在平台上线初期，我们曾使用 InfluxDB 直接存储用户端上报的原始日志，并使用 CQ 功能聚合出 分钟级、小时级 粒度的聚合表。 但随着接入应用数的增多、上报日志量 的持续增长，CQ 功能查询的内存开销出现了成倍的增长，导致 InfluxDB 的查询性能骤降。</p><p>随后我们在架构中引入了 流计算引擎 Flink , C 端上报数据经过 外部计算引擎 预聚合后，再存入 InfluxDB。 经过这样的调整后，InfluxDB 只存储 C 端用户 每分钟、每小时的 聚合结果，每分钟存储量只与 series 量级(group by 维度组合结果量级) 挂钩，不再与用户量直接关联。 InfluxDB 自身的查询性能也得到保障。</p><p><img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/25813626113/3a14/a156/48e9/8d00d4f9ff0fcc7a33191dd04ae751c9.png" class="img_ev3q"></p><p>举例来说，我们可以在 Flink 中配置分钟级 PV 聚合任务：</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   TUMBLE_START(PROCTIME(), INTERVAL &#x27;1&#x27; MINUTE) as wTime,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   count(os) as pv,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   os as osName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   moduleName as moduleName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM performance_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    props[&#x27;mspm&#x27;] = &#x27;ReactNativeApplication&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GROUP BY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TUMBLE(PROCTIME(), INTERVAL &#x27;1&#x27; MINUTE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    os,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    props[&#x27;moduleName&#x27;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们将 Flink 的聚合结果，写入 InfluxDB 表中，表结构示例如下 (moduleName、osName 为 tag 列, pv 为 field 列):</p><table><thead><tr><th>time</th><th>moduleName</th><th>osName</th><th>pv</th></tr></thead><tbody><tr><td>2023-01-01 12:00:00</td><td>rn-app-1</td><td>android</td><td>10000</td></tr><tr><td>2023-01-01 12:00:00</td><td>rn-app-1</td><td>iphone</td><td>8000</td></tr><tr><td>2023-01-01 12:00:00</td><td>rn-app-2</td><td>android</td><td>5000</td></tr><tr><td>2023-01-01 12:00:00</td><td>rn-app-2</td><td>iphone</td><td>4000</td></tr><tr><td>2023-01-01 12:01:00</td><td>rn-app-1</td><td>android</td><td>10000</td></tr><tr><td>2023-01-01 12:01:00</td><td>...</td><td>...</td><td>...</td></tr><tr><td>...</td><td>...</td><td>...</td><td>...</td></tr></tbody></table><p>这样在查询 每小时、每天 PV 走势时，我们可以直接基于 分钟级表 的数据做分析，相较于查询 每个用户上报的原始日志，查询数据量级大幅降低、性能大幅提升。 (聪明的读者一定想到了，这里的 Flink 与 之前介绍的 InfluxDB CQ 的作用其实是一致的)</p><p>后续我们可以这样查询 InfluxDB:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   moduleName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   osName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> pv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> rn_minute_pv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   moduleName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;rn-app-1&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   osName</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;android&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">time</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token string" style="color:#e3116c">&#x27;2023-01-01&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">time</span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token string" style="color:#e3116c">&#x27;2023-01-02&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查询结果:
time|moduleName|osName|pv
----|----|----|----
2023-01-01 12:00:00| rn-app-1 | android | 600000 |
2023-01-01 13:00:00| rn-app-1 | android | 600000 |
2023-01-01 14:00:00 | rn-app-1 | android | 600000 |
...|...|...|...</p><ol start="2"><li>存储 「原始」数据</li></ol><p>Corona 使用 InfluxDB 的另一个场景是存储 平台自身运行健康度的 「原始」数据，提升平台自身运行的可观测。 相较于 C 端场景 的海量数据，机器、集群的健康度数据量级较为可控，我们可以使用 InfluxDB 进行存储、 CQ 计算。</p><p><img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/25813618765/8a94/0cef/531a/149c1e8d843c1c290ffec87a95f98538.png" class="img_ev3q"></p><p>例如当我们需要观测 自建的「数据消费服务」的健康度时，我们使用 InfluxDB 采集每个进程 每次批量处理的 事件数，同时包含 机器、进程、事件上报平台 等维度列。 表结构示例如下:
time| hostname| pid | platform | events
---|---|---|---|---
2023-01-01 12:00:03| music-corona-worker-1 | 130616 | web | 10
2023-01-01 12:00:04| music-corona-worker-1 | 128204 | android | 50
2023-01-01 12:00:04| music-corona-worker-2 | 33096 | ios | 30
...|...|...|...|...</p><p>有了原始数据表，我们可以按 hostname 维度、platform 维度 观测集群的数据消费健康度。可视化方案推荐使用 <a href="https://grafana.com/docs/grafana/latest/" target="_blank" rel="noopener noreferrer">Grafna</a> :</p><p><img loading="lazy" src="https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/25811684057/f86e/5476/6ad1/44105d090fb5944ae4d17cfe14e1acbb.png" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-集群部署">3.3 集群部署<a href="#33-集群部署" class="hash-link" aria-label="3.3 集群部署的直接链接" title="3.3 集群部署的直接链接">​</a></h3><p><a href="https://docs.influxdata.com/influxdb/v2.6/get-started/" target="_blank" rel="noopener noreferrer">InfluxDB</a> 目前在社区只开源了单机版，如果我们有 高可用、节点扩展 等需求 可以尝试使用官方付费服务。 除此之外 国内厂商 也有一些高可用实践，主要的两个技术路线代表有</p><ul><li>饿了么 <a href="https://github.com/shell909090/influx-proxy" target="_blank" rel="noopener noreferrer">influx-proxy</a></li><li>网易 <a href="https://kms.netease.com/article/5933" target="_blank" rel="noopener noreferrer">NTSDB</a> (内网可见)</li></ul><ol><li>influx-proxy</li></ol><p>influx-proxy 是一个 HTTP 代理服务，对 InfluxDB 客户端透明。 influx-proxy 主要提供了以下功能:</p><ul><li>以 measurement 粒度做数据分片、横向扩展节点</li><li>可以实现数据的双写备份</li><li>写失败时，缓存重试能力</li><li>高危查询语句过滤能力</li></ul><p><img loading="lazy" src="https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/25816109124/5d67/951f/d9b8/3d14ac8f57d5d4554b30697384d194fd.png" class="img_ev3q">
架构图取自<a href="https://github.com/shell909090/influx-proxy" target="_blank" rel="noopener noreferrer">influx-proxy</a></p><ol start="2"><li>NTSDB</li></ol><p>NTSDB 是网易自研的一款高性能分布式时序数据库，核心功能是为时序数据业务提供三高服务：读写服务高可用、数据高可靠以及读写高性能。除此之外，NTSDB 还拥有非常便捷的扩容缩容能力。</p><p>由于 NTSDB 尚未对集团外部开放，本文就不过多展开，内网用户可以参考这篇<a href="https://kms.netease.com/article/5933" target="_blank" rel="noopener noreferrer">介绍文章</a>, 外网用户可以通过 <a href="http://hbasefly.com/category/%e6%97%b6%e5%ba%8f%e6%95%b0%e6%8d%ae%e5%ba%93/" target="_blank" rel="noopener noreferrer">NTSDB 作者博客</a> 学习更多时序数据库底层实现原理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四小结">四.小结<a href="#四小结" class="hash-link" aria-label="四.小结的直接链接" title="四.小结的直接链接">​</a></h2><p>InfluxDB 作为一款经典的时序数据库，能够满足时序分析场景下的大部分诉求，并且使用时也足够轻便 和 灵活。但在业务的实践的过程中，我们也踩了一些坑，其中最痛的还是 内存的持续增长 导致 OOM 的问题。 在集群资源有限的前提下，我们也逐渐摸索到了 InfluxDB 的使用边界 和 驾驭它的正确姿势。</p><p>下篇文章我们将继续介绍时序数据分析专题，并为你带来 ElasticSearch、ClickHouse 两款数据库在时序分析场景下的应用介绍，他们在使用姿势、 数据分析能力上 与 InfluxDB 又会有哪些差异呢？</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/时序数据库、influxdb">时序数据库、influxdb</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="本篇文章介绍了 ES(ElasticSearch) 搜索相关的基本概念"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/elasticsearch-basic">ES(ElasticSearch) 搜索基本概念简介</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2020-04-02T00:00:00.000Z" itemprop="datePublished">2020年4月2日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/34838245?v=4" alt="kkdev163" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">kkdev163</span></a></div><small class="avatar__subtitle" itemprop="description">Web 全栈开发工程师@NetEase</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>本篇文章介绍了 ES(ElasticSearch) 搜索相关的基本概念</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/搜索">搜索</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/es">ES</a></li></ul></div><div class="col text--right col--3"><a aria-label="阅读 ES(ElasticSearch) 搜索基本概念简介 的全文" href="/blog/elasticsearch-basic"><b>阅读更多</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="前言"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/lighthouse">Lighthous 测试内幕</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-11-12T00:00:00.000Z" itemprop="datePublished">2019年11月12日</time> · <!-- -->阅读需 23 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/34838245?v=4" alt="kkdev163" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">kkdev163</span></a></div><small class="avatar__subtitle" itemprop="description">Web 全栈开发工程师@NetEase</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>云音乐前端性能监控平台，底层使用了 Lighthouse 进行审计评分，在实践过程中我们积累了一些 Lighthouse 内部实现的研究经验，希望通过这篇文章可以分享给各位读者。</p><p>本篇文章基于 Lighthouse 5.2.0 版本，介绍了 Lighthouse 的测试流程、架构模块实现、性能指标的计算等。通过这篇文章，读者可以了解到 Lighthouse 是如何做自动化测试的、如何在 Lighthouse 的框架上自定义一些审计项、关键的性能指标是如何模拟计算的。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/lighthouse">lighthouse</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/performance">performance</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/web">web</a></li></ul></div><div class="col text--right col--3"><a aria-label="阅读 Lighthous 测试内幕 的全文" href="/blog/lighthouse"><b>阅读更多</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="前言"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/wapm-storage">前端性能监控平台-存储与计算架构展望</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-03-29T00:00:00.000Z" itemprop="datePublished">2019年3月29日</time> · <!-- -->阅读需 12 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/34838245?v=4" alt="kkdev163" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">kkdev163</span></a></div><small class="avatar__subtitle" itemprop="description">Web 全栈开发工程师@NetEase</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h3><p>本文首先介绍网易云音乐自研前端性能监控平台的架构现状和当前遇到的问题。随后介绍了 NTSDB 存储引擎可以解决的问题，并进一步给出更符合业界标准的监控平台存储与计算架构。文中 NTSDB 与业界通用架构主要是根据网易数据科学中心时序数据库领域专家-<a href="http://hbasefly.com/author/libisthanksgmail-com/" target="_blank" rel="noopener noreferrer">范欣欣</a>给出的建议整理而来。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/influxdb">influxdb</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/performance">performance</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/web">web</a></li></ul></div><div class="col text--right col--3"><a aria-label="阅读 前端性能监控平台-存储与计算架构展望 的全文" href="/blog/wapm-storage"><b>阅读更多</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="前言"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/sentry-sshfs">Sentry平台-为Docker Swarm集群添加SSHFS分布式文件存储</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2019-03-28T00:00:00.000Z" itemprop="datePublished">2019年3月28日</time> · <!-- -->阅读需 7 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/34838245?v=4" alt="kkdev163" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://kkdev163.github.io" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">kkdev163</span></a></div><small class="avatar__subtitle" itemprop="description">Web 全栈开发工程师@NetEase</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h3><p>本文首先介绍了网易云音乐私有化部署的 Sentry 平台系统架构和当前业务上遇到的分布式存储问题，最后给出搭建 SSHFS 存储环境解决该问题的实现步骤。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sentry">sentry</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sshfs">sshfs</a></li></ul></div><div class="col text--right col--3"><a aria-label="阅读 Sentry平台-为Docker Swarm集群添加SSHFS分布式文件存储 的全文" href="/blog/sentry-sshfs"><b>阅读更多</b></a></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 kkdev163. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.69c15619.js"></script>
<script src="/assets/js/main.8e1951b7.js"></script>
</body>
</html>